<body>
<h2>메뉴 보기</h2>
<div id="cart-link">
    <a href="/cart">장바구니로 이동</a>
    <span id="cart-count">장바구니에 0개의 상품이 있습니다.</span>
</div>

<form th:action="@{/menu}" method="get">
    <div>
        <label>분류:</label>
        <input type="checkbox" name="category" value="KOR"> 한식
        <input type="checkbox" name="category" value="CHN"> 중식
        <input type="checkbox" name="category" value="JPN"> 일식
        <input type="checkbox" name="category" value="WESTERN"> 양식
        <input type="checkbox" name="category" value="SNACK"> 분식
    </div>
    <div>
        <label>가격대:</label>
        <input type="checkbox" name="priceRange" value="below_10000"> 만원 이하
        <input type="checkbox" name="priceRange" value="10000_20000"> 1만원~2만원
        <input type="checkbox" name="priceRange" value="above_20000"> 2만원 이상
    </div>
    <div>
        <label>혼밥가능여부:</label>
        <input type="radio" name="isAlone" value="true"> 가능
        <input type="radio" name="isAlone" value="false"> 불가능
    </div>

    <label>정렬</label>
    <select name="sort">
        <option value="rating">평점순</option>
        <option value="busy">혼잡도순</option>
        <option value="likes">좋아요순</option>
    </select>
    <button type="submit">조회</button>
</form>

<h2>결과 출력</h2>
<table>
    <thead>
    <tr>
        <th>이름</th>
        <th>가게 이름</th>
        <th>분류</th>
        <th>내용</th>
        <th>가격</th>
        <th>조리시간</th>
        <th>혼잡도</th>
        <th>혼밥가능여부</th>
        <th>좋아요수</th>
        <th>메뉴 평점</th>
        <th>수량</th>
        <th>장바구니</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="menu : ${menus}" th:attr="data-menu-id=${menu.id}">
        <td><a th:href="@{/menu/{id}(id=${menu.id})}" th:text="${menu.name}"></a></td>
        <td th:text="${menu.storeDTO.name}"></td>
        <td th:text="${menu.storeDTO.categoryKorName}"></td>
        <td th:text="${menu.content}"></td>
        <td th:text="${menu.price}"></td>
        <td th:text="${menu.cookingTime}"></td>
        <td th:text="${menu.storeDTO.busyKorName}"></td>
        <td th:text="${menu.isAlone ? 'Yes' : 'No'}"></td>
        <td th:text="${likeCounts[menu.storeDTO.storeId]}"></td>
        <td th:text="${averageRatings[menu.id]}"></td>
        <td>
            <input type="number" name="quantity" min="1" value="1"/>
        </td>
        <td>
            <button th:onclick="'addToCart(' + ${menu.id} + ')'" >담기</button>
        </td>
    </tr>
    </tbody>
</table>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function addToCart(menuId) {
        const row = $("tr[data-menu-id=" + menuId + "]");
        const quantity = row.find('input[name="quantity"]').val();

        $.ajax({
            url: "/cart/add",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                menuDTO: {id: menuId},
                menuCount: quantity
            }),
            success: function (response) {
                alert(response); // 성공 메시지
                updateCartCount(); // 장바구니 카운트 업데이트
            },
            error: function (xhr) {
                console.error("Error Status: " + xhr.status); // 콘솔에 상태 코드 출력
                console.error("Error Response: " + xhr.responseText); // 콘솔에 응답 내용 출력

                if (xhr.status === 400) {
                    alert("같은 가게의 메뉴만 담을 수 있습니다");
                } else if (xhr.status === 401) {
                    alert("로그인 해주세요");
                    window.location.href = "/login";
                } else {
                    alert("오류가 발생했습니다 다시 시도해 주세요");
                }
            }
        });
    }

    function updateCartCount() {
        $.get("/cart/count", function (count) {
            $("#cart-count").text("장바구니에 " + count + "개의 메뉴가 담겨 있습니다");
        });
    }

    $(document).ready(function () {
        updateCartCount();
    });
</script>
</body>


